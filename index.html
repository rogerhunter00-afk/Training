<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Start</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
  <div id="app"></div>
  <script src="assets/app.js"></script>
  <script>
    const {
      initLayout,
      loadState,
      updateState,
      COURSE_TITLE,
      getCourseDashboard
    } = window.ALSApp;

    const main = initLayout('Start / Resume');
    const state = loadState();
    const hasName = !!state.learner.name;
    const dashboard = getCourseDashboard(state);

    function renderStartForm(){
      main.innerHTML = `
        <section class="card">
          <h2>${COURSE_TITLE}</h2>
          <p>Estimated duration: 35â€“55 minutes.</p>
          <p>Pass mark: 80% on final quiz. Critical questions Q4 and Q7 must be correct.</p>
          <form id="startForm">
            <label>Full name (required)
              <input type="text" id="fullName" required value="${state.learner.name || ''}">
            </label>
            <div class="nav-buttons">
              <button class="btn" type="submit">Start course</button>
            </div>
          </form>
        </section>`;

      main.querySelector('#startForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const name = main.querySelector('#fullName').value.trim();
        if(!name){
          alert('Name required.');
          return;
        }
        updateState(s=>{
          s.learner.name = name;
          s.learner.createdAtISO ||= new Date().toISOString();
          s.course.startedAtISO ||= new Date().toISOString();
        });
        location.href = 'course.html';
      });
    }

    function renderDashboardCard(){
      main.innerHTML = `
        <section class="card">
          <h2>Welcome back, ${state.learner.name}</h2>
          <p class="muted">Current module: <strong>${dashboard.currentModuleTitle}</strong></p>
          <p>${dashboard.completedCount} of ${dashboard.totalModules} modules complete</p>
          <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="${dashboard.totalModules}" aria-valuenow="${dashboard.completedCount}" aria-label="Course completion">
            <span style="width:${dashboard.progressPercent}%"></span>
          </div>
          <p class="muted">Quiz eligibility: ${dashboard.quizReady ? 'Ready for final assessment.' : 'Complete all modules to unlock final assessment.'}</p>
          <div class="nav-buttons">
            <a href="${dashboard.primaryHref}" class="btn">${dashboard.primaryLabel}</a>
            <a href="quiz.html" class="btn secondary" id="finalAssessmentLink">Go to final assessment</a>
          </div>
        </section>`;

      main.querySelector('#finalAssessmentLink')?.addEventListener('click', (e)=>{
        if(dashboard.quizReady) return;
        e.preventDefault();
        const proceed = confirm('Some modules are still incomplete. Starting the final assessment now may reduce your chance of passing. Continue anyway?');
        if(proceed){
          location.href = 'quiz.html';
        }
      });
    }

    if(hasName){
      renderDashboardCard();
    } else {
      renderStartForm();
    }
  </script>
</body>
</html>
